# Руководство пользователя

## Установка
Установите с помощью [`pipx`](https://pypa.github.io/pipx/), что предотвращает конфликты с системными пакетами Python:

=== "MacOS"
    ```bash
    brew install pipx
    pipx ensurepath
    ```

=== "Linux"
    ```bash
    python3 -m pip install --user pipx
    python3 -m pipx ensurepath
    ```

=== "Windows"
    ```bash
    # Если вы установили python через app-store, замените `python` на `python3` в следующей строке.
    python -m pip install --user pipx
    ```

После настройки `pipx` установите `ibkr-porez`:

```bash
pipx install ibkr-porez
```

## Настройка

Перед первым использованием запустите команду конфигурации, чтобы сохранить учетные данные IBKR и личные данные.

```bash
ibkr-porez config
```

Вам будет предложено ввести:
*   **IBKR Flex Token**: (Из настроек IBKR)
*   **IBKR Query ID**: (Из вашего Flex-запроса)
*   **Personal ID**: (JMBG для налоговых форм)
*   **Full Name**: (Полное имя для налоговых форм)
*   **Address**: (Адрес для налоговых форм)
*   **City Code**: 3-значный код муниципалитета. Пример: `223` (Нови Сад). Код можно найти в [справочнике](https://www.apml.gov.rs/uploads/useruploads/Documents/1533_1_pravilnik-javni_prihodi_prilog-3.pdf) (смотрите колонку "Шифра"). Также код доступен в выпадающем списке на портале ePorezi.
*   **Phone**: (Телефон для контакта)
*   **Email**: (Email для контакта)

## 1. Получение данных (`get`)

Загружает последние данные из IBKR и синхронизирует курсы валют с НБС (Национальный банк Сербии).

```bash
ibkr-porez get

# Принудительное полное обновление (игнорировать локальную историю и загрузить последние 365 дней)
ibkr-porez get --force
```

*   Загружает XML-отчет, используя ваши Token и Query ID.
*   Парсит новые транзакции (Сделки, Дивиденды).
*   Сохраняет их в локальное хранилище.
*   Получает исторические курсы валют для всех дат транзакций.
*   **По умолчанию**: Загружает данные инкрементально (только новые транзакции с момента последней загрузки).
*   **--force**: используйте это, если хотите обновить старые данные.

## 2. Импорт исторических данных (`import`)

Используйте эту команду для загрузки истории транзакций старше 365 дней (которые невозможно получить через Flex Query).

1.  Скачайте **Custom Statement** на сайте IBKR (Activity Statement -> Custom -> Format: CSV) за недостающий период.
2.  Импортируйте файл:

```bash
ibkr-porez import /path/to/activity_statement.csv
```

### Логика синхронизации (`import` + `get`)
При совместном использовании CSV (Import) и XML (Get) система автоматически обрабатывает наложения:
*   **Приоритет XML**: Официальные данные XML (`get`) являются источником правды. Они перезаписывают данные CSV за любые совпадающие даты.
*   **Updated**: Если запись XML совпадает с CSV по смыслу (Дата, Тикер, Цена, Количество), это считается **Обновлением** (заменой на официальный ID).
*   **New**: Если структура данных отличается (например, сплит ордеров в XML против "склеенной" записи в CSV), старая запись CSV удаляется, а новые записи XML добавляются. Они отображаются как **New**.
*   **Identical**: Полностью идентичные записи пропускаются.

## 3. Просмотр статистики (`show`)

Отображает сводку активности портфеля с группировкой по месяцам.

```bash
ibkr-porez show
```

Показывает:
*   Полученные дивиденды (в RSD).
*   Количество продаж (налогооблагаемых событий).
*   Оценку реализованного P/L (Капитальный доход) (в RSD).

## 4. Генерация налогового отчета (`report`)

Генерирует XML-файл PPDG-3R для Налоговой администрации Сербии.

```bash
# Отчет за первое полугодие 2024 (1 янв - 30 июн)
ibkr-porez report --year 2024 --half 1

# Отчет за второе полугодие 2024 (1 июл - 31 дек)
ibkr-porez report --year 2024 --half 2
```

*   **Результат**: `ppdg3r_2024_H1.xml`
*   Импортируйте этот файл на портал Налоговой администрации Сербии (ePorezi).

## Устранение неполадок

*   **Отсутствуют данные**: Убедитесь, что ваш Flex Query в IBKR настроен на охват соответствующих дат (например, "Last 365 Days").
*   **Курсы валют**: Если сайт НБС недоступен, инструмент может не конвертировать валюты. Попробуйте снова позже.
